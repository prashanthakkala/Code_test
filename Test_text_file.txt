import pdfplumber
from pdfminer.layout import LAParams
import pandas as pd

# Define LAParams with custom values
laparams = LAParams(
    char_margin=2.0,
    line_margin=0.5,
    word_margin=0.1,
    boxes_flow=0.5
)

# Initialize an empty list to store DataFrames from each page
all_data = []

# Open the PDF file
with pdfplumber.open("example.pdf") as pdf:
    for page_num, page in enumerate(pdf.pages):
        # Extract tables
        tables = page.extract_tables({
            "vertical_strategy": "lines",
            "horizontal_strategy": "lines",
            "intersection_tolerance": 5,
            "snap_tolerance": 3,
            "join_tolerance": 3,
            "edge_min_length": 10,
            "min_words_vertical": 1,
            "min_words_horizontal": 1
        })

        # Identify the bottom Y-coordinate of the last table's last row
        last_table_bottom_y = 0
        if tables:
            for table in tables:
                if table:
                    words = page.extract_words()
                    if words:
                        last_table_bottom_y = max(word['bottom'] for word in words)

        # Extract all text lines on the page
        all_text = page.extract_text(laparams=laparams).splitlines()

        # Extract text rows that appear after the last table
        remaining_text = []
        for word in page.extract_words():
            if word['bottom'] > last_table_bottom_y:
                remaining_text.append(word['text'])

        # Join remaining text into a single string, one per row
        remaining_text_str = ' '.join(remaining_text)

        # Convert the last table to a DataFrame
        if tables:
            df_table = pd.DataFrame(tables[-1][1:], columns=tables[-1][0])  # Assuming the first row is the header
        else:
            df_table = pd.DataFrame()

        # If there is remaining text, add it as the last row of the DataFrame
        if not df_table.empty and remaining_text:
            # Create a new row with the remaining text in a new "Remaining Text" column
            df_text_row = pd.DataFrame([["" for _ in range(len(df_table.columns))] + [remaining_text_str]],
                                       columns=list(df_table.columns) + ["Remaining Text"])
            df_table = pd.concat([df_table, df_text_row], ignore_index=True)
        elif remaining_text:
            # If no table, just create a DataFrame with the remaining text
            df_table = pd.DataFrame([[remaining_text_str]], columns=["Remaining Text"])

        # Append the DataFrame to the list
        all_data.append(df_table.reset_index(drop=True))

# Combine all DataFrames into a single DataFrame
combined_df = pd.concat(all_data, ignore_index=True)

# Output the combined DataFrame
print(combined_df)
