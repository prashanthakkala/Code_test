import pdfplumber
import pandas as pd

def extract_tables_with_advanced_bottom_check(pdf_path):
    tables_list = []

    with pdfplumber.open(pdf_path) as pdf:
        for page_num, page in enumerate(pdf.pages):
            # Extract tables using pdfplumber
            tables = page.extract_tables()
            page_height = page.height
            
            # Extract lines of text from the bottom of the page
            bottom_margin = 50  # Adjust this margin as needed
            last_rows_text = page.crop((0, page_height - bottom_margin, page.width, page_height)).extract_text()

            if last_rows_text:
                last_rows_lines = last_rows_text.split('\n')

            for table in tables:
                # Convert table to DataFrame
                df = pd.DataFrame(table)
                # Add page number to the DataFrame
                df['Page'] = page_num + 1

                # Check each extracted line against the table's last row
                for line in last_rows_lines:
                    line_cells = line.split()
                    if len(line_cells) == len(df.columns) - 1:  # Compare with table columns count (excluding 'Page')
                        # Check if the line is not already in the table
                        if not df.iloc[-1, :-1].tolist() == line_cells:
                            # Append the line to the table
                            line_cells.append(page_num + 1)  # Add the page number
                            df = df.append(pd.Series(line_cells, index=df.columns), ignore_index=True)

                tables_list.append(df)

    # Combine all DataFrames into one
    final_df = pd.concat(tables_list, ignore_index=True)
    return final_df

# Usage
pdf_path = "your_pdf_file.pdf"
tables_df = extract_tables_with_advanced_bottom_check(pdf_path)

# Display the combined DataFrame
print(tables_df)
